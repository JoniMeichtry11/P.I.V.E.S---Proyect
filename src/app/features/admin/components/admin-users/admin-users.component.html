<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 text-white">
  <!-- Header -->
  <header class="bg-slate-800/80 backdrop-blur-md border-b border-slate-700/50 sticky top-0 z-30">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <button (click)="goBack()" class="text-slate-400 hover:text-white transition-colors text-2xl">â†</button>
        <div>
          <h1 class="text-xl font-bold text-white">ğŸ‘¥ GestiÃ³n de Usuarios</h1>
          <p class="text-xs text-slate-400">{{ users.length }} usuarios registrados</p>
        </div>
      </div>
      <button (click)="loadUsers()"
        class="px-4 py-2 text-sm bg-slate-700 hover:bg-slate-600 rounded-lg transition-colors border border-slate-600">
        ğŸ”„ Refrescar
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
    <!-- Modal de confirmaciÃ³n -->
    @if (confirmModal.isOpen) {
      <div class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-2xl shadow-2xl p-6 max-w-md w-full border border-slate-600">
          <h2 class="text-xl font-bold text-white mb-2">{{ confirmModal.title }}</h2>
          <p class="text-slate-300 text-sm mb-6">{{ confirmModal.message }}</p>
          <div class="flex gap-3 justify-end">
            <button (click)="closeConfirmModal()"
              class="px-4 py-2 bg-slate-600 hover:bg-slate-500 rounded-lg transition-colors text-sm">
              Cancelar
            </button>
            <button (click)="confirmModal.action()"
              class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded-lg transition-colors text-sm font-bold">
              SÃ­, eliminar
            </button>
          </div>
        </div>
      </div>
    }

    @if (loading) {
      <div class="flex items-center justify-center h-64">
        <div class="text-center">
          <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
          <p class="text-slate-400">Cargando usuarios...</p>
        </div>
      </div>
    }

    @if (!loading) {
      <div class="space-y-4">
        @for (user of users; track user.uid) {
          <div class="bg-slate-800/60 border border-slate-700/50 rounded-2xl overflow-hidden transition-all duration-300"
               [class.border-blue-500/30]="isExpanded(user.uid)">
            <!-- Fila principal del usuario -->
            <button (click)="toggleExpand(user.uid)"
              class="w-full p-4 sm:p-5 flex items-center justify-between text-left hover:bg-slate-700/30 transition-colors">
              <div class="flex items-center gap-4 flex-1 min-w-0">
                <div class="w-11 h-11 bg-blue-600/20 rounded-xl flex items-center justify-center text-xl flex-shrink-0">
                  ğŸ‘¤
                </div>
                <div class="min-w-0 flex-1">
                  <p class="font-bold text-white truncate">{{ user.parent?.name || 'Sin nombre' }}</p>
                  <p class="text-xs text-slate-400 truncate">{{ user.parent?.email || 'Sin email' }}</p>
                </div>
              </div>
              <div class="hidden sm:flex items-center gap-6 text-sm text-slate-400 flex-shrink-0">
                <span title="Hijos">ğŸ§’ {{ (user.children || []).length }}</span>
                <span title="Reservas activas">ğŸ“… {{ getActiveBookings(user) }}</span>
                <span title="Combustible total">â›½ {{ getTotalFuel(user) }}</span>
              </div>
              <span class="ml-4 text-slate-500 transition-transform duration-300"
                    [class.rotate-180]="isExpanded(user.uid)">â–¼</span>
            </button>

            <!-- Detalle expandido -->
            @if (isExpanded(user.uid)) {
              <div class="border-t border-slate-700/50 bg-slate-900/40 p-4 sm:p-6 space-y-4 animate-fade-in">
                <!-- Info del padre -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-sm">
                  <div class="bg-slate-800/60 rounded-lg p-3">
                    <span class="text-slate-500 text-xs uppercase">Email</span>
                    <p class="text-white font-mono text-xs mt-1 break-all">{{ user.parent?.email || '-' }}</p>
                  </div>
                  <div class="bg-slate-800/60 rounded-lg p-3">
                    <span class="text-slate-500 text-xs uppercase">TelÃ©fono</span>
                    <p class="text-white mt-1">{{ user.parent?.phone || '-' }}</p>
                  </div>
                  <div class="bg-slate-800/60 rounded-lg p-3">
                    <span class="text-slate-500 text-xs uppercase">UID</span>
                    <p class="text-white font-mono text-xs mt-1 break-all">{{ user.uid }}</p>
                  </div>
                </div>

                <!-- Hijos -->
                <h4 class="text-sm font-bold text-slate-300 uppercase tracking-wider mt-2">Hijos registrados</h4>
                @for (child of user.children || []; track child.id) {
                  <div class="bg-slate-800/40 border border-slate-700/40 rounded-xl p-4">
                    <div class="flex items-center justify-between flex-wrap gap-3">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">{{ child.avatar }}</span>
                        <div>
                          <p class="font-bold text-white">{{ child.name }}</p>
                          <p class="text-xs text-slate-400">{{ child.gender === 'male' ? 'NiÃ±o' : 'NiÃ±a' }}</p>
                        </div>
                      </div>
                      <div class="flex items-center gap-4 text-sm">
                        <span class="text-amber-400">â›½ {{ child.progress?.fuelLiters || 0 }} Lts</span>
                        <span class="text-green-400">ğŸï¸ Nivel {{ child.progress?.currentCardIndex || 0 }}</span>
                        <span class="text-blue-400">ğŸ… {{ child.progress?.ruedas || 0 }} ruedas</span>
                      </div>
                    </div>

                    <!-- Agregar combustible -->
                    <div class="mt-3 flex items-center gap-2 flex-wrap">
                      <input type="number" min="1" placeholder="Litros"
                        [value]="getFuelAmount(user.uid, child.id)"
                        (input)="setFuelAmount(user.uid, child.id, $any($event.target).valueAsNumber)"
                        class="w-24 px-3 py-1.5 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-amber-500 focus:border-amber-500" />
                      <button (click)="addFuel(user.uid, child.id)"
                        class="px-4 py-1.5 bg-amber-600 hover:bg-amber-500 rounded-lg text-sm font-bold transition-colors">
                        â›½ Agregar
                      </button>
                    </div>

                    <!-- Reservas del hijo -->
                    @if ((child.bookings || []).length > 0) {
                      <div class="mt-3">
                        <p class="text-xs text-slate-500 uppercase mb-2">Reservas ({{ (child.bookings || []).length }})</p>
                        <div class="space-y-1">
                          @for (booking of child.bookings || []; track booking.id) {
                            <div class="flex items-center justify-between bg-slate-900/50 rounded-lg px-3 py-2 text-xs">
                              <div class="flex items-center gap-2">
                                <span [class.text-green-400]="booking.status === 'active'"
                                      [class.text-slate-500]="booking.status === 'completed'"
                                      [class.text-red-400]="booking.status === 'cancelled'">â—</span>
                                <span class="text-white">{{ booking.car?.name || '?' }}</span>
                                <span class="text-slate-400">{{ booking.date }} {{ booking.time }}</span>
                              </div>
                              <span class="uppercase px-2 py-0.5 rounded text-xs font-bold"
                                [class.bg-green-900/50]="booking.status === 'active'"
                                [class.text-green-400]="booking.status === 'active'"
                                [class.bg-slate-700]="booking.status === 'completed'"
                                [class.text-slate-400]="booking.status === 'completed'"
                                [class.bg-red-900/50]="booking.status === 'cancelled'"
                                [class.text-red-400]="booking.status === 'cancelled'">
                                {{ booking.status }}
                              </span>
                            </div>
                          }
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Acciones -->
                <div class="flex justify-end gap-3 pt-2">
                  <button (click)="toggleAdminRole(user)"
                    [class.bg-blue-600]="user.isAdmin"
                    [class.bg-slate-700]="!user.isAdmin"
                    class="px-4 py-2 hover:opacity-80 rounded-lg text-sm transition-all border border-blue-500/30">
                    {{ user.isAdmin ? 'ğŸ‘‘ Quitar Admin' : 'ğŸ›¡ï¸ Hacer Admin' }}
                  </button>
                  <button (click)="confirmDeleteUser(user)"
                    class="px-4 py-2 bg-red-600/30 hover:bg-red-600 text-red-400 hover:text-white border border-red-600/40 rounded-lg text-sm transition-all">
                    ğŸ—‘ï¸ Eliminar usuario
                  </button>
                </div>
              </div>
            }
          </div>
        }

        @if (users.length === 0) {
          <div class="text-center py-16 text-slate-500">
            <span class="text-5xl block mb-4">ğŸ“­</span>
            <p class="text-lg">No hay usuarios registrados</p>
          </div>
        }
      </div>
    }
  </main>
</div>
