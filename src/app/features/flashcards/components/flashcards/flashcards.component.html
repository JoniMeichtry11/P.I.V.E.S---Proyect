<!-- VISTA: MENÃš DE NIVELES -->
@if (viewMode === 'menu') {
  <div class="max-w-4xl mx-auto p-4 md:p-8">
    <div class="flex items-center justify-between mb-8">
      <button (click)="handleBackToMenu(); router.navigate(['/home'])" class="text-blue-600 font-bold hover:underline flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm">
        &larr; Volver al Inicio
      </button>
      <h1 class="text-3xl md:text-4xl font-display text-slate-700 text-center grow">
        Ãlbum de DesafÃ­os
      </h1>
      <div class="w-24"></div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl border-b-8 border-slate-200">
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        @for (index of levels; track index) {
          <button
            type="button"
            [disabled]="index > (activeChild?.progress?.currentCardIndex || 0)"
            (click)="handleSelectLevel(index)"
            [class.bg-green-100]="index < (activeChild?.progress?.currentCardIndex || 0)"
            [class.border-green-300]="index < (activeChild?.progress?.currentCardIndex || 0)"
            [class.hover:bg-green-200]="index < (activeChild?.progress?.currentCardIndex || 0)"
            [class.bg-amber-100]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.border-amber-300]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.hover:scale-105]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.hover:bg-amber-200]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.shadow-lg]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.ring-2]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.ring-amber-400]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.ring-offset-2]="index === (activeChild?.progress?.currentCardIndex || 0)"
            [class.bg-slate-100]="index > (activeChild?.progress?.currentCardIndex || 0)"
            [class.border-slate-200]="index > (activeChild?.progress?.currentCardIndex || 0)"
            [class.opacity-60]="index > (activeChild?.progress?.currentCardIndex || 0)"
            [class.cursor-not-allowed]="index > (activeChild?.progress?.currentCardIndex || 0)"
            class="relative h-36 rounded-2xl flex flex-col items-center justify-center p-2 border-b-4 transition-all duration-300"
            >
            <span [class.text-amber-700]="index === (activeChild?.progress?.currentCardIndex || 0)" [class.text-slate-600]="index !== (activeChild?.progress?.currentCardIndex || 0)" class="text-xl font-display mb-1">Nivel {{ index + 1 }}</span>
            @if (index < (activeChild?.progress?.currentCardIndex || 0)) {
              <span class="text-4xl drop-shadow-sm">âœ…</span>
            }
            @if (index === (activeChild?.progress?.currentCardIndex || 0)) {
              <span class="text-5xl drop-shadow-md animate-bounce">ğŸš¦</span>
            }
            @if (index > (activeChild?.progress?.currentCardIndex || 0)) {
              <span class="text-4xl opacity-50">ğŸ”’</span>
            }
          </button>
        }
      </div>
    </div>
  </div>
}

<!-- VISTA: RESULTADO FINAL DE LA TARJETA -->
@if (viewMode === 'game' && showCardResult) {
  <div class="text-center max-w-xl mx-auto p-4 md:p-8 flex flex-col items-center justify-center min-h-[60vh]">
    <img [src]="wasCardSuccessful ? MARA_HAPPY_URL : MARA_THINKING_URL" alt="Mara" class="w-32 h-32 mx-auto mb-4 object-contain drop-shadow-lg"/>
    <h1 [class.text-green-600]="wasCardSuccessful" [class.text-orange-600]="!wasCardSuccessful" class="text-3xl font-display mb-2">
      {{ wasCardSuccessful ? 'Â¡Nivel Completado!' : 'Â¡IntÃ©ntalo de nuevo!' }}
    </h1>
    
    @if (isSavingProgress) {
      <div class="flex items-center gap-2 text-blue-500 text-sm font-bold mb-4 animate-pulse">
        <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
        Sincronizando progreso...
      </div>
    }

    <!-- RESUMEN DE RESPUESTAS -->
    <div class="w-full bg-slate-50 rounded-xl p-4 mb-6 shadow-inner text-left max-h-60 overflow-y-auto border border-slate-200">
      <h3 class="text-sm font-bold text-slate-500 uppercase mb-3 text-center">Resumen de Respuestas</h3>
      <div class="space-y-3">
        @for (item of answersSummary; track item; let idx = $index) {
          <div class="flex items-start gap-3 border-b border-slate-200 pb-2 last:border-0">
            <div [class.text-green-500]="item.isCorrect" [class.text-red-500]="!item.isCorrect" class="mt-1 text-lg">
              {{ item.isCorrect ? 'âœ…' : 'âŒ' }}
            </div>
            <div>
              <p class="font-bold text-slate-700 text-sm">{{ item.question }}</p>
              <p [class.text-green-600]="item.isCorrect" [class.text-red-500]="!item.isCorrect" [class.font-semibold]="item.isCorrect" [class.line-through]="!item.isCorrect" class="text-sm">
                Tu respuesta: {{ item.userAnswer }}
              </p>
              @if (!item.isCorrect) {
                <p class="text-xs text-green-600 font-bold mt-1">
                  Correcta: {{ item.correctAnswer }}
                </p>
              }
            </div>
          </div>
        }
      </div>
    </div>
    <div class="flex flex-col gap-3 w-full max-w-sm">
      @if (wasCardSuccessful && isLastLevelOfGame) {
        <button (click)="handleGoToBooking()" type="button" class="w-full py-4 px-6 bg-linear-to-r from-green-500 to-emerald-600 text-white font-display text-xl rounded-2xl hover:scale-105 shadow-lg transition-transform">
          ğŸš— Ir a Reservar Coche
        </button>
      }
      @if (wasCardSuccessful && !isLastLevelOfGame) {
        <button (click)="handleDirectNextLevel()" type="button" class="w-full py-4 px-6 bg-linear-to-r from-blue-500 to-indigo-600 text-white font-display text-xl rounded-2xl hover:scale-105 shadow-lg transition-transform flex items-center justify-center gap-2">
          Siguiente Nivel â¡ï¸
        </button>
      }
      @if (!wasCardSuccessful) {
        <button (click)="handleRetryCard()" type="button" class="w-full py-3 px-6 bg-amber-500 text-white font-bold rounded-xl hover:bg-amber-600 border-b-4 border-amber-700">
          ğŸ”„ Reintentar Nivel
        </button>
      }
      <button (click)="handleBackToMenu()" type="button" class="w-full py-3 px-6 bg-slate-200 text-slate-700 font-bold rounded-xl hover:bg-slate-300 mt-2">
        Volver al Mapa
      </button>
    </div>
  </div>
}

<!-- VISTA: PREGUNTA (JUEGO) -->
@if (viewMode === 'game' && !showCardResult && currentQuestion) {
  <div class="max-w-2xl mx-auto p-4">
    <button (click)="handleBackToMenu()" type="button" class="mb-4 text-sm text-slate-500 hover:text-blue-600 font-bold flex items-center gap-1 bg-white px-3 py-1 rounded-full shadow-sm w-fit">
      <span>ğŸ—ºï¸</span> Salir al Mapa
    </button>
    <div class="bg-white rounded-3xl shadow-xl p-6 md:p-8 relative border-b-8 border-slate-100">
      <div class="flex justify-between items-end mb-4 border-b border-slate-100 pb-4">
        <div>
          <p class="text-slate-400 font-bold text-sm uppercase tracking-wider">Nivel {{ playingCardIndex + 1 }}</p>
          <h2 class="text-xl font-display text-slate-700">Pregunta {{ questionInCardIndex + 1 }} de {{ QUESTIONS_PER_CARD }}</h2>
        </div>
        <div class="text-right">
          <span [class.bg-blue-100]="currentQuestion.audience === 'parent'" [class.text-blue-700]="currentQuestion.audience === 'parent'" [class.bg-amber-100]="currentQuestion.audience === 'child'" [class.text-amber-700]="currentQuestion.audience === 'child'" class="inline-block px-3 py-1 text-xs font-bold rounded-full">
            {{ currentQuestion.audience === 'parent' ? 'Adultos ğŸ‘¨' : 'NiÃ±os ğŸ‘¶' }}
          </span>
        </div>
      </div>
      <div class="w-full bg-slate-100 rounded-full h-3 mb-6">
        <div class="bg-green-500 h-3 rounded-full transition-all duration-500" [style.width.%]="progressPercentage"></div>
      </div>
      <div class="flex justify-center items-center mb-6 h-56 w-full bg-slate-50 rounded-2xl border-2 border-slate-100 p-2">
        <img [src]="currentQuestion.image" alt="SeÃ±al de trÃ¡nsito" class="h-full object-contain rounded-lg"/>
      </div>
      <div class="flex items-start justify-between gap-4 mb-6">
        <h2 class="text-xl md:text-2xl font-bold text-slate-800 leading-tight">{{ currentQuestion.text }}</h2>
        <button
          type="button"
          (click)="handleSpeak()"
          [class.bg-blue-500]="isSpeaking"
          [class.text-white]="isSpeaking"
          [class.animate-pulse]="isSpeaking"
          [class.bg-white]="!isSpeaking"
          [class.text-blue-500]="!isSpeaking"
          [class.border-2]="!isSpeaking"
          [class.border-blue-100]="!isSpeaking"
          [class.hover:scale-110]="!isSpeaking"
          class="shrink-0 p-3 rounded-full transition-all duration-300 shadow-md"
          >
          ğŸ”Š
        </button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        @for (option of shuffledOptions; track option; let index = $index) {
          <button
            type="button"
            (click)="handleAnswer(index)"
            [disabled]="showFeedback"
            [class.bg-slate-50]="!showFeedback && selectedAnswer !== index"
            [class.text-slate-700]="!showFeedback && selectedAnswer !== index"
            [class.border-2]="!showFeedback"
            [class.border-slate-100]="!showFeedback && selectedAnswer !== index"
            [class.hover:border-blue-300]="!showFeedback && selectedAnswer !== index"
            [class.bg-green-500]="showFeedback && selectedAnswer === index && isCorrect"
            [class.text-white]="showFeedback && (selectedAnswer === index || index === correctShuffledIndex)"
            [class.border-green-600]="showFeedback && selectedAnswer === index && isCorrect"
            [class.bg-red-500]="showFeedback && selectedAnswer === index && !isCorrect"
            [class.border-red-600]="showFeedback && selectedAnswer === index && !isCorrect"
            [class.bg-green-100]="showFeedback && index === correctShuffledIndex && selectedAnswer !== index"
            [class.text-green-800]="showFeedback && index === correctShuffledIndex && selectedAnswer !== index"
            [class.border-green-500]="showFeedback && index === correctShuffledIndex && selectedAnswer !== index"
            [class.ring-4]="currentlySpeakingIndex === index"
            [class.ring-blue-400]="currentlySpeakingIndex === index"
            [class.hover:scale-[1.02]]="!showFeedback"
            [class.active:scale-95]="!showFeedback"
            class="p-4 rounded-xl text-lg font-bold text-left transition-all duration-200"
            >
            {{ option }}
          </button>
        }
      </div>
      @if (showFeedback) {
        <div [class.bg-green-500]="isCorrect" [class.bg-red-500]="!isCorrect" class="mt-6 p-4 rounded-2xl text-white flex flex-col items-center gap-3 animate-bounce-in shadow-lg" [class.shadow-green-200]="isCorrect" [class.shadow-red-200]="!isCorrect">
          <div class="flex items-center gap-4 w-full">
            <div class="text-4xl bg-white/20 rounded-full p-2">{{ isCorrect ? 'ğŸ‰' : 'ğŸ¤”' }}</div>
            <div>
              <h3 class="font-bold text-xl">{{ isCorrect ? 'Â¡Correcto!' : 'Â¡Ups, casi!' }}</h3>
              <p class="text-sm font-medium opacity-90">{{ currentQuestion.explanation }}</p>
            </div>
          </div>
          <button (click)="handleNext()" type="button" class="w-full mt-2 py-3 px-4 bg-white text-slate-800 font-bold rounded-xl hover:bg-slate-100 transition-colors shadow-md">
            {{ questionInCardIndex === QUESTIONS_PER_CARD - 1 ? 'Ver Resultado' : 'Siguiente Pregunta' }}
          </button>
        </div>
      }
    </div>
  </div>
}

