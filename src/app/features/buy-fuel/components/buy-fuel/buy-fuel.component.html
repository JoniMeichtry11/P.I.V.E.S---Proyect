<div class="max-w-4xl mx-auto p-4 md:p-8 space-y-12">



  <!-- ======================== CONTENIDO ======================== -->

  <h1 class="text-4xl md:text-5xl font-display text-center text-slate-700">Estaci√≥n de Servicio</h1>

  @if (feedbackMessage) {
    <div
      [class.bg-green-500]="feedbackMessage.type === 'success'"
      [class.bg-red-500]="feedbackMessage.type === 'error'"
      [class.bg-amber-500]="feedbackMessage.type === 'pending'"
      class="p-4 rounded-lg text-center font-bold text-white shadow-md">
      {{ feedbackMessage.text }}
    </div>
  }

  <!-- Paquetes de Combustible -->
  <div class="bg-white p-6 rounded-2xl shadow-xl">
    <h2 class="text-3xl font-display text-slate-800 mb-2 text-center">Paquetes de Combustible</h2>
    <p class="text-center text-slate-500 text-sm mb-6">Compr√° litros y us√°los para reservar autos en la pista</p>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      @for (pkg of FUEL_PACKAGES; track pkg) {
        <div [class]="'relative p-5 rounded-xl text-white bg-linear-to-br ' + pkg.bgColor + ' flex flex-col items-center justify-between shadow-lg'">
          @if (pkg.bonus) {
            <span class="absolute -top-3 left-1/2 -translate-x-1/2 bg-yellow-400 text-yellow-900 text-xs font-bold px-3 py-1 rounded-full whitespace-nowrap">{{ pkg.bonus }}</span>
          }
          <div class="text-center pt-2">
            <p class="text-5xl font-display">{{ pkg.liters }}</p>
            <p class="font-bold text-2xl">‚õΩ</p>
            <p class="text-white/80 text-xs mt-1">Litros</p>
          </div>
          
          <div class="w-full mt-4">
            @if (activeChild?.progress?.activeDiscount) {
              <div class="text-center mb-1">
                <span class="text-xs line-through text-white/60">$ {{ pkg.price.toLocaleString('es-AR') }}</span>
                <span class="ml-2 bg-white text-slate-800 text-[10px] font-bold px-1.5 py-0.5 rounded">
                  -{{ activeChild?.progress?.activeDiscount }}%
                </span>
              </div>
              <button (click)="handleSelectPackage(pkg)" class="w-full bg-white text-slate-900 transition-all active:scale-95 font-bold py-2 px-4 rounded-lg">
                $ {{ calculateDiscountedPrice(pkg.price).toLocaleString('es-AR') }}
              </button>
            } @else {
              <button (click)="handleSelectPackage(pkg)" class="w-full bg-white/30 hover:bg-white/50 transition-all active:scale-95 font-bold py-2 px-4 rounded-lg">
                $ {{ pkg.price.toLocaleString('es-AR') }}
              </button>
            }
          </div>
        </div>

      }
    </div>
    
    <!-- Borrar esta secci√≥n cuando est√© sea funcional -->
    <div class="flex flex-col items-center mt-8 p-4 bg-slate-50 rounded-xl border border-dashed border-slate-300">
      <button (click)="onTestPayment()" 
        class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-6 rounded-lg transition-all active:scale-95 flex items-center gap-2">
        <span>üß™</span> Probar con $1 ARS
      </button>
    </div>

    <div class="flex items-center justify-center gap-3 mt-6 pt-4 border-t border-slate-100">
      <img src="https://i.ibb.co/5W3WGp79/MPago.png" alt="MercadoPago" class="h-6 opacity-60"/>
      <p class="text-xs text-slate-400">Pagos procesados de forma segura por MercadoPago</p>
    </div>
  </div>

  <!-- Canjear Cup√≥n -->
  <div class="bg-white p-6 rounded-2xl shadow-xl">
    <h2 class="text-3xl font-display text-slate-800 mb-6 text-center">Canjear Cup√≥n de Combustible</h2>
    <p class="text-center text-slate-500 mb-4 max-w-md mx-auto">
      Si ten√©s un cup√≥n de un evento o regalo, ¬°ingresalo aqu√≠ para cargar tu tanque!
    </p>
    <form (ngSubmit)="handleRedeemCodeSubmit()" class="flex flex-col md:flex-row gap-2 max-w-sm mx-auto">
      <input
        type="text"
        [(ngModel)]="redeemCode"
        name="redeemCode"
        [disabled]="isValidatingCoupon"
        placeholder="Ej: PIVESREGALO25"
        class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-center font-mono uppercase"
        />
      <button type="submit" [disabled]="isValidatingCoupon || !redeemCode.trim()" 
        class="px-6 py-3 bg-blue-500 text-white font-bold rounded-lg hover:bg-blue-600 whitespace-nowrap disabled:bg-slate-400">
        {{ isValidatingCoupon ? 'Validando...' : 'Canjear' }}
      </button>

    </form>
  </div>

</div>

<!-- ======================== MODALES ======================== -->


<!-- Modal: Crear preferencia / Redirigir a MP -->
@if (selectedPackage && !isCreatingPreference) {
  <div class="fixed inset-0 w-screen h-screen bg-black/60 z-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm w-full relative">
      <button (click)="closePaymentModal()" title="Cerrar" class="absolute top-3 right-3 text-slate-400 hover:text-slate-700 text-3xl leading-none font-bold">&times;</button>

      <h2 class="text-2xl font-display text-slate-800 text-center mb-4">Finalizar Carga</h2>

      <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-center mb-6">
        <p class="text-slate-500 text-sm">Est√°s cargando</p>
        <p class="text-4xl font-display text-amber-600 mt-1">{{ selectedPackage.liters }} Litros ‚õΩ</p>
        
        @if (activeChild?.progress?.activeDiscount) {
          <div class="flex items-center justify-center gap-2 mt-1">
            <span class="text-sm line-through text-slate-400">$ {{ selectedPackage.price.toLocaleString('es-AR') }}</span>
            <span class="font-bold text-xl text-slate-800">$ {{ calculateDiscountedPrice(selectedPackage.price).toLocaleString('es-AR') }} ARS</span>
          </div>
        } @else {
          <p class="font-bold text-xl text-slate-800 mt-1">$ {{ selectedPackage.price.toLocaleString('es-AR') }} ARS</p>
        }
      </div>


      <button
        (click)="handleFinalizePayment()"
        class="w-full bg-[#FFE600] hover:bg-[#f0d900] active:scale-95 transition-all text-slate-800 font-bold py-4 rounded-xl flex items-center justify-center gap-3 shadow-md">
        Comprar con Mercado Pago
      </button>

      <p class="text-center text-xs text-slate-400 mt-3">üîí Pago seguro. Tarjetas, billeteras y m√°s.</p>
    </div>
  </div>
}

<!-- Modal: Creando preferencia (loader) -->
@if (isCreatingPreference) {
  <div class="fixed inset-0 w-screen h-screen bg-black/70 z-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
      <h2 class="text-2xl font-display text-slate-700 mt-4">Preparando tu pago...</h2>
      <p class="text-slate-500 mt-2">Conectando con MercadoPago de forma segura.</p>
    </div>
  </div>
}

